#CI for product catalog service
name: product-catalog

on:
     pull_request:
          branches:
               - main

jobs:
    build:  
        runs-on: ubuntu-latest
        steps:
        - name: checkout code
          uses: actions/checkout@v4
        
        - name: Go setup 1.22.1
          uses: actions/setup-go@v4
          with:
            go-version: 1.22.1
        #build the Go application
        - name: Build the Go application
          run: |
               cd src/product-catalog
               go mod download
               go build -o product-catalog main.go
        #unit test of the application
        - name: Run unit tests
          run: |
               cd src/product-catalog
               go test ./...
        
    code-quality:
        runs-on: ubuntu-latest
        steps:
        - name: Checkout code
          uses: actions/checkout@v4


        - name: Run GOlnagci-lint
          run: |
            go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
            golangci-lint run src/product-catalog/...


    Docker:
        runs-on: ubuntu-latest
        needs: build
        steps:
        - name: checkout code
          uses: actions/checkout@v4

        - name: Install Docker Buildx
          uses: docker/setup-buildx-action@v2
          with:
            version: latest
    
        #login and build the docker image
        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
               username: ${{ secrets.DOCKER_USERNAME }}
               password: ${{ secrets.DOCKER_TOKEN }}
        - name: Build and push Docker image
          uses: docker/build-push-action@v6
          with:
               context: src/product-catalog
               file: src/product-catalog/Dockerfile
               push: true
               tags: ravi685/product-catalog:${{ github.run_id }}
    updatek8s:
        runs-on: ubuntu-latest
        needs: Docker

        steps:
        - name: checkout code
          uses: actions/checkout@v4
          with:
            token: ${{ secrets.GITHUB_TOKEN }}
        - name: update the tag in k8s deployment file
          run: |
            sed -i "s|image: .*|image: ${{ secrets.DOCKER_USERNAME }}/product-catalog:${{github.run_id}}|" kubernetes/productcatalog/deploy.yaml
         
        - name: Commit and push changes
          run: |
            git config --global user.name "ravish142000"
            git config --global user.email "ravish142000@gmail.com"
            git add kubernetes/productcatalog/deploy.yaml
            git commit -m "[CI]Update image tag to ${{ github.sha }}"
            git push 
        
        

 
  
                    

                